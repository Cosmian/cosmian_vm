{
  "builders": [
    {
      "type": "googlecompute",
      "project_id": "amd-sev-snp",
      "source_image": "ubuntu-2204-jammy-v20231030",
      "source_image_family": "ubuntu-2204-lts",
      "zone": "europe-west4-a",
      "ssh_username": "root",
      "ssh_timeout": "2m",
      "image_name": "cosmian-vm-{{timestamp}}",
      "image_guest_os_features": ["SEV_SNP_CAPABLE"],
      "network": "default",
      "subnetwork": "default",
      "tags": ["ssh-full"],
      "use_os_login": true
    }
  ],
  "provisioners": [
    {
      "type": "shell",
      "execute_command": "sudo -E /bin/bash '{{.Path}}'",
      "inline": ["whoami"]
    },
    {
      "type": "file",
      "source": "/home/runner/work/cosmian_vm/cosmian_vm/crate/agent",
      "destination": "/tmp/cosmian_vm_agent"
    },
    {
      "type": "file",
      "source": "../resources/data",
      "destination": "/tmp/data"
    },
    {
      "type": "shell",
      "execute_command": "sudo -E /bin/bash '{{.Path}}'",
      "inline": 
        [
          "mkdir -p /root/data",
          "mv /tmp/cosmian_vm_agent /usr/sbin/", 
          "mv /tmp/data/ /root"
        ]
    },
    {
      "type": "shell",
      "execute_command": "sudo -E /bin/bash '{{.Path}}'",
      "inline": ["sudo ls -la /root/data"]
    },
    {
      "type": "ansible",
      "playbook_file": "../ansible/cosmian_vm_playbook.yml",
      "local_port": 22,
      "use_proxy": false
    }
  ]
}
