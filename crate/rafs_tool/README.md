# RAFS-TOOL

`rafs-tool` is designed to be installed inside a SGX enclave or a SEV VM between a data processing program (inside the same trusted environment) and a data provisioning/consuming program (outside that trusted environment).

It's main goal is to receive encrypted data from an untrusted environment and present them in plain text inside the trusted environment. 

Reciprocally, it will also receive plaintext data from the trusted environment and present them encrypted outside the untrusted environment.

Note: `rafs-tool` only works on SEV for now.

By doing that, you allow someone to share data with a trusted environment through an unsecure environment. The processing program do not have to be adapted to process these data. 

## Usage

Let's assume the following file tree:

- `input_enc`: is a directory shared between a secure and an unsecure environment. A user outside the secure environment will write encrypted files in it
- `input_plain`: is a directory only allowed in the secure environment. It contains the files from `input_enc` in plain text. These files can be processed by any other program inside the trusted environment
- `output_plain`: is a directory only allowed in the secure environment. It contains files generated by programs inside the trusted environment designed to be shared outside the secure environment
- `output_enc`: is a directory shared between a secure and an unsecure environment. A user outside the secure environment will read encrypted file from it

As explained before, `rafs-tool` will decrypt the files from `input_enc` into `input_plain` and encrypt files from `output_plain` into `output_enc`.

Also, the folder `shared` contains the quote and the public key of the secure environment to be used by any client wanted to share encrypted data with the secure environment through `input_enc`.

### Start the proxy inside the trusted environment

```console
$ sudo ./rafs-tool proxy --client-public-key key.pub 
```

The quote and the public key of the trusted environment will be generated in the  `shared` directory.

The `client-public-key` value has to be generated first. The proxy will encrypt the files from `output_plain` into `output_enc` using that key. You can first generated that key as follow:

```console
$ ./rafs-tool init
```

### Send a file to the trusted environment

From an insecure environment, run:

```console
$ ./rafs-tool encrypt -f file.txt -q shared/quote -k shared/key.pub -o input_enc/
```

The encrypted file will be consumed by the proxy. Any program inside the trusted environment can now read it in plain text. 

Let's emulate a processing generating a file in `output_plain`:

```console
echo "test" > output_plain
```

The proxy will automatically encrypt it inside `output_enc`.

### Receive a file from the trusted environment

From an insecure environment, run:

```console
$ ./rafs-tool decrypt -f output_enc/1694005052535029488 --private-key key.pem
$ cat 1694007004456967312
```

`key.pem` is the key generated previously by the `init` subcommand.