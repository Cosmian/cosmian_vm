---
# tasks file for check cosmian vm

- name: Check Cosmian VM Agent version
  ansible.builtin.debug:
    var: cosmian_vm_version

- name: Check SSH remote host IP
  ansible.builtin.debug:
    var: inventory_hostname

- name: Open port 5555 on RHEL
  when: ansible_distribution == 'RedHat'
  block:
    - name: Add rule to firewall
      ansible.posix.firewalld:
        zone: public
        port: 5555/tcp
        permanent: yes
        state: present

    - name: Reload firewall configuration
      ansible.posix.firewalld:
        state: reload

    - name: Comment ipv6 ref in /etc/hosts file
      ansible.builtin.template:
        src: hosts
        dest: /etc/hosts
        owner: root
        group: root
        mode: "0644"

- name: Check if port 5555 is listening
  ansible.builtin.wait_for:
    host: "{{ inventory_hostname }}"
    port: 5555
    delay: 5
    timeout: 60
    msg: Timeout waiting for 5555 to respond

- name: Check if port 5555 is listening on {{ inventory_hostname }}
  ansible.builtin.uri:
    url: https://{{ inventory_hostname }}:5555/ima/ascii
    validate_certs: false
  delegate_to: localhost
  become: false

- name: Clean potential existing Cosmian VM CLI and snapshot
  ansible.builtin.command:
    cmd: |
      rm -f ./cosmian_vm
      rm -f ./cosmian_vm.snapshot
  delegate_to: localhost

- name: Download Cosmian VM CLI
  ansible.builtin.get_url:
    url: https://package.cosmian.com/cosmian_vm/{{ cosmian_vm_version }}/cosmian_vm
    dest: .
    mode: "u+x"
  delegate_to: localhost
  become: false

- name: Cosmian VM snapshot
  ansible.builtin.command:
    cmd: |
      ./cosmian_vm --url https://{{ inventory_hostname }}:5555 --allow-insecure-tls snapshot
  register: cosmian_vm_output
  delegate_to: localhost
  become: false
  ignore_errors: true
  tags: snapshot

- name: Display agent logs variable
  ansible.builtin.debug:
    var: cosmian_vm_output
  tags: snapshot

- name: Read Cosmian VM agent logs
  ansible.builtin.slurp:
    src: /var/log/cosmian_vm/agent.out.log
  register: agent_logs
  tags: snapshot

- name: Display Agent logs
  ansible.builtin.debug:
    var: "{{ agent_logs['content'] | b64decode }}"
  tags: snapshot

- name: Fail if Cosmian snapshot has failed previously
  ansible.builtin.fail:
    msg: Cosmian snapshot failed with return code {{ cosmian_vm_output }}
  when:
    - cosmian_vm_output is defined
    - cosmian_vm_output.rc is defined
    - cosmian_vm_output.rc != 0
  tags: snapshot

- name: Verify Cosmian VM snapshot
  ansible.builtin.command:
    cmd: |
      ./cosmian_vm --url https://{{ inventory_hostname }}:5555 --allow-insecure-tls verify --snapshot cosmian_vm.snapshot
  register: verify_cosmian_vm_output
  delegate_to: localhost
  become: false
  ignore_errors: true
  tags: verify

- name: Display agent logs variable
  ansible.builtin.debug:
    var: verify_cosmian_vm_output
  tags: verify

- name: Read Cosmian VM agent logs
  ansible.builtin.slurp:
    src: /var/log/cosmian_vm/agent.out.log
  register: agent_logs
  tags: verify

- name: Display Agent logs
  ansible.builtin.debug:
    var: "{{ agent_logs['content'] | b64decode }}"
  tags: verify

- name: Fail if Cosmian snapshot verification has failed previously
  ansible.builtin.fail:
    msg: Cosmian snapshot verification failed with return code {{ verify_cosmian_vm_output }}
  when:
    - verify_cosmian_vm_output is defined
    - verify_cosmian_vm_output.rc is defined
    - verify_cosmian_vm_output.rc != 0
  tags: verify

- name: Clean Cosmian VM CLI and snapshot
  ansible.builtin.command:
    cmd: |
      rm -f ./cosmian_vm
      rm -f ./cosmian_vm.snapshot
  delegate_to: localhost
