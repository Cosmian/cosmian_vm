---
# tasks file for ansible/roles/tpm

- name: Check OS distribution
  ansible.builtin.debug:
    var: ansible_distribution

- name: TPM packages installation on Ubuntu
  when: ansible_distribution == 'Ubuntu'
  block:
    - name: Update packages cache
      ansible.builtin.apt:
        update_cache: true

    - name: Install packages
      ansible.builtin.apt:
        name: tpm2-tools
        state: present
        update_cache: true

- name: TPM packages installation on RedHat
  when: ansible_distribution == 'RedHat' or ansible_distribution == 'CentOS' or ansible_distribution == 'Rocky'
  block:
    - name: Update packages cache
      ansible.builtin.dnf:
        update_cache: true

    - name: Install packages
      ansible.builtin.dnf:
        name:
          - tpm2-tools
          - cryptsetup
        state: present
        update_cache: true

- name: TPM packages installation on Amazon-linux
  when: ansible_distribution == 'Amazon'
  block:
    - name: Update all packages to their latest version
      ansible.builtin.dnf:
        update_cache: true

    - name: Download and unzip tpm2-tools
      ansible.builtin.unarchive:
        src: https://package.cosmian.com/tpm2-tools/tpm2-tools-amazonlinux-20240116.zip
        dest: /tmp/
        remote_src: true

    - name: Install tpm2-tools
      ansible.builtin.command:
        cmd:
          ./install.sh
      args:
        chdir: /tmp/tpm2-tools

    - name: Clean tpm2-tools
      ansible.builtin.file:
        path: /tmp/tpm2-tools/
        state: absent

    - name: Install packages tpm2-tss
      ansible.builtin.dnf:
        name: tpm2-tss
        state: present
        update_cache: true
