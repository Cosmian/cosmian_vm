---
# tasks file for KMS startup

- name: Check SSH remote host IP
  ansible.builtin.debug:
    var: inventory_hostname

- name: Make sure a Supervisor service is running
  ansible.builtin.systemd_service:
    state: started
    name: supervisor
  tags: launch

- name: Run Redis
  ansible.builtin.systemd_service:
    state: started
    name: redis

- name: Check if port 6379 is listening
  ansible.builtin.wait_for:
    port: 6379
    delay: 5
    timeout: 30
    msg: Timeout waiting for 6379 to respond

- name: Start Cosmian VM agent
  community.general.supervisorctl:
    name: cosmian_vm_agent
    state: started
  tags: launch

- name: Override Cosmian VM supervisor configuration with autostart to true
  when: ansible_distribution == 'Ubuntu'
  ansible.builtin.lineinfile:
    path: /etc/supervisor/conf.d/cosmian_vm_agent.conf
    regexp: autostart=false
    line: autostart=true
    backup: true

- name: Override Cosmian VM supervisor configuration with autostart to true
  when: ansible_distribution == 'RedHat' or ansible_distribution == 'CentOS' or ansible_distribution == 'Rocky'
  ansible.builtin.lineinfile:
    path: /etc/supervisord.d/cosmian_vm_agent.ini
    regexp: autostart=false
    line: autostart=true
    backup: true

- name: Check if port 5355 is listening
  ansible.builtin.wait_for:
    port: 5355
    delay: 5
    timeout: 30
    msg: Timeout waiting for 5355 to respond
  tags: launch

- name: Check Cosmian VM Agent is OK
  ansible.builtin.uri:
    url: https://{{ inventory_hostname }}:5355/ima/ascii
    validate_certs: false
  delegate_to: localhost

  tags: listening

- name: Read LUKS password
  ansible.builtin.slurp:
    src: /var/lib/cosmian_vm/data/luks_password
  register: luks_password

- name: Display LUKS password
  ansible.builtin.debug:
    var: "{{ luks_password['content'] | b64decode }}"

- name: Run Nginx
  ansible.builtin.systemd_service:
    state: restarted
    name: nginx

- name: Creates app directory
  ansible.builtin.file:
    path: /var/lib/cosmian_vm/data/app
    state: directory
    owner: root
    group: root
    mode: "0644"

- name: Check Cosmian VM Agent version
  ansible.builtin.debug:
    var: cosmian_vm_version

- name: Download Cosmian VM CLI
  ansible.builtin.get_url:
    url: https://package.cosmian.com/cosmian_vm/{{ cosmian_vm_version }}/cosmian_vm
    dest: /tmp/
    mode: "u+x"
  delegate_to: localhost

- name: Copy KMS configuration
  ansible.builtin.template:
    src: kms.toml.j2
    dest: /tmp/kms.toml
    mode: "0644"
  delegate_to: localhost

- name: Cosmian VM App initialization
  ansible.builtin.command:
    cmd: |
      /tmp/cosmian_vm --url https://{{ inventory_hostname }}:5355 --allow-insecure-tls app init -c /tmp/kms.toml
  register: cosmian_vm_output
  ignore_errors: true
  delegate_to: localhost
  tags: app_init

- name: Display agent logs variable
  ansible.builtin.debug:
    var: cosmian_vm_output
  tags: app_init

- name: Read Cosmian VM agent logs
  ansible.builtin.slurp:
    src: /var/log/cosmian_vm/agent.out.log
  register: agent_logs
  tags: app_init

- name: Display Agent logs
  ansible.builtin.debug:
    var: "{{ agent_logs['content'] | b64decode }}"
  tags: app_init

- name: Fail if Cosmian app init has failed previously
  ansible.builtin.fail:
    msg: Cosmian app init failed with return code {{ cosmian_vm_output }}
  when:
    - cosmian_vm_output is defined
    - cosmian_vm_output.rc is defined
    - cosmian_vm_output.rc != 0
  tags: app_init

- name: Override KMS supervisor configuration with autostart to true
  when: ansible_distribution == 'Ubuntu'
  ansible.builtin.lineinfile:
    path: /etc/supervisor/conf.d/cosmian_kms.conf
    regexp: autostart=false
    line: autostart=true
    backup: true

- name: Override KMS supervisor configuration with autostart to true
  when: ansible_distribution == 'RedHat' or ansible_distribution == 'CentOS' or ansible_distribution == 'Rocky'
  ansible.builtin.lineinfile:
    path: /etc/supervisord.d/cosmian_kms.ini
    regexp: autostart=false
    line: autostart=true
    backup: true

- name: Start KMS
  community.general.supervisorctl:
    name: cosmian_kms
    state: started
  tags: launch

- name: Run Nginx
  ansible.builtin.systemd_service:
    state: restarted
    name: nginx

- name: Check if port 8080 is listening
  ansible.builtin.wait_for:
    host: "{{ inventory_hostname }}"
    port: 8080
    delay: 5
    timeout: 30
    msg: Timeout waiting for 8080 to respond
  delegate_to: localhost
  tags: listening

- name: Check if port 443 is listening
  ansible.builtin.wait_for:
    host: "{{ inventory_hostname }}"
    port: 443
    delay: 5
    timeout: 30
    msg: Timeout waiting for 443 to respond
  delegate_to: localhost
  tags: listening

- name: Check KMS returns its version
  ansible.builtin.uri:
    url: http://{{ inventory_hostname }}:8080/version
  delegate_to: localhost
  tags: listening

- name: Check KMS returns its version on HTTPS
  ansible.builtin.uri:
    url: https://{{ inventory_hostname }}/version
    validate_certs: false
  delegate_to: localhost
  tags: listening

- name: Reboot since all checks pass
  ansible.builtin.reboot:
