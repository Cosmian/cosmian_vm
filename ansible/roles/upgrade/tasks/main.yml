---
# tasks file for upgrade

- name: Update and upgrade apt packages
  when: ansible_distribution == 'Ubuntu'
  block:
    - name: Update and upgrade apt packages
      ansible.builtin.apt:
        update_cache: true
        only_upgrade: true
        upgrade: safe
      tags: ubuntu

    # Update grub
    - name: Update grub
      ansible.builtin.command: update-grub
      register: cmd_output
      changed_when: cmd_output.rc != 0

- name: Upgrade all packages
  when: ansible_distribution == 'RedHat'
  block:
    - name: Install required packages
      ansible.builtin.dnf:
        name:
          - python-firewall
          - firewalld
          - policycoreutils-python-utils
          - selinux-policy
          - kernel
          - kernel-devel
          - kernel-headers
          - kernel-tools
          - kernel-tools-libs
        state: present

    - name: Update all packages
      ansible.builtin.dnf:
        name: "*"
        state: latest
        update_only: true
      tags: redhat

    - name: Update security packages
      ansible.builtin.dnf:
        security: true
        state: latest
        update_only: true

    - name: Display security patches
      ansible.builtin.shell:
        cmd: |
          dnf updateinfo list security
      register: dnf_security_update
      changed_when: dnf_security_update.rc != 0

    - name: Display Security updates
      ansible.builtin.debug:
        var: dnf_security_update
