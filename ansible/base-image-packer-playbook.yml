---
- name: Setup base image
  hosts: all
  become: true
  roles:
    - role: configure_ima
      tags: role-configure-ima
    - tpm
    - instance_configs # GCP only
    - intel
    - role: upgrade
      tags: role-upgrade
    - no_updates
    - cosmian_vm_agent

- name: Reboot after GRUB changes, Linux updates and TPM support installation
  hosts: all
  become: true
  tasks:
    - name: Reboot the system
      ansible.builtin.reboot:
        connect_timeout: 3600
        reboot_timeout: 3600
      when: reboot_allowed

    - name: Check /proc/cmdline
      ansible.builtin.command: cat /proc/cmdline
      register: cmdline
      changed_when: cmdline.rc != 0

    - name: Display /proc/cmdline
      ansible.builtin.debug:
        var: cmdline

    # - name: Check if command output contains 'earlyprintk'
    #   ansible.builtin.fail:
    #     msg: "The command 'cat /proc/cmdline' output does not contain the substring 'earlyprintk'"
    #   when: "'earlyprintk' not in cmdline.stdout"
